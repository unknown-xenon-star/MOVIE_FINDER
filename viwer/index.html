<!DOCTYPE html>
<html>
<head>
    <title>Movie Scraper Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f9;
            padding: 20px;
        }
        h1 { margin-bottom: 10px; }
        h2 { margin-top: 40px; }

        .card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            font-size: 13px;
            vertical-align: top;
        }

        th {
            background: #222;
            color: white;
        }

        tr:nth-child(even) {
            background: #f9f9f9;
        }

        img {
            width: 60px;
            border-radius: 4px;
        }

        .success { color: green; font-weight: bold; }
        .error { color: red; font-size: 12px; }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            background: #007bff;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            margin: 2px;
        }

        .toggle-btn {
            cursor: pointer;
            background: #333;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 10px;
        }

        .hidden { display: none; }
        .muted { color: #666; font-size: 12px; }
        .load-more {
            cursor: pointer;
            background: #0b5ed7;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>

<h1>Movie Scraper Dashboard</h1>

<div id="configSection" class="card"></div>

<h2>Completed Tasks</h2>
<div id="completedSection" class="card"></div>

<h2>Failed Tasks</h2>
<table>
    <thead>
        <tr>
            <th>Task</th>
            <th>Error</th>
        </tr>
    </thead>
    <tbody id="failedTable"></tbody>
</table>

<h2>Movie Records</h2>
<button id="recordsMoreBtn" class="load-more hidden" type="button">Load More Records</button>
<table>
    <thead>
        <tr>
            <th>Poster</th>
            <th>Title</th>
            <th>Year</th>
            <th>Language</th>
            <th>Description</th>
            <th>Links</th>
        </tr>
    </thead>
    <tbody id="recordsTable"></tbody>
</table>

<h2>Movie Details Cache</h2>
<div class="toggle-btn" onclick="toggleCache()">Show / Hide Cache</div>
<button id="cacheMoreBtn" class="load-more hidden" type="button">Load More Cache</button>

<table id="cacheTable" class="hidden">
    <thead>
        <tr>
            <th>Key</th>
            <th>Details (JSON)</th>
        </tr>
    </thead>
    <tbody id="cacheBody"></tbody>
</table>

<script>
function toggleCache() {
    document.getElementById("cacheTable").classList.toggle("hidden");
}

const RECORDS_BATCH_SIZE = 50;
const CACHE_BATCH_SIZE = 30;
const MAX_TEXT_LENGTH = 180;
let recordsOffset = 0;
let cacheOffset = 0;
let recordsData = [];
let cacheEntries = [];

function truncateText(value, maxLen = MAX_TEXT_LENGTH) {
    const text = String(value || "");
    return text.length > maxLen ? `${text.slice(0, maxLen)}...` : text;
}

function setButtonState(buttonId, isVisible, label) {
    const btn = document.getElementById(buttonId);
    if (!btn) return;
    btn.classList.toggle("hidden", !isVisible);
    if (label) btn.textContent = label;
}

function renderRecordsBatch() {
    const table = document.getElementById('recordsTable');
    const end = Math.min(recordsOffset + RECORDS_BATCH_SIZE, recordsData.length);
    const fragment = document.createDocumentFragment();

    for (let i = recordsOffset; i < end; i++) {
        const movie = recordsData[i] || {};
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><img loading="lazy" decoding="async" src="${movie.poster_url || ''}" alt="Poster"></td>
            <td>${truncateText(movie.title, 120)}</td>
            <td>${movie.year || ''}</td>
            <td>${truncateText(movie.language, 80)}</td>
            <td>${truncateText(movie.description, 220)}</td>
            <td>
                <a href="${movie.movie_page_url || '#'}" target="_blank" rel="noopener noreferrer">Movie Page</a><br>
                <a href="${movie.source_url || '#'}" target="_blank" rel="noopener noreferrer">Source</a>
            </td>
        `;
        fragment.appendChild(row);
    }

    table.appendChild(fragment);
    recordsOffset = end;

    setButtonState(
        "recordsMoreBtn",
        recordsOffset < recordsData.length,
        `Load More Records (${recordsOffset}/${recordsData.length})`
    );
}

function renderCacheBatch() {
    const body = document.getElementById('cacheBody');
    const end = Math.min(cacheOffset + CACHE_BATCH_SIZE, cacheEntries.length);
    const fragment = document.createDocumentFragment();

    for (let i = cacheOffset; i < end; i++) {
        const [key, details] = cacheEntries[i];
        const row = document.createElement('tr');
        const compact = truncateText(JSON.stringify(details), 350);
        row.innerHTML = `
            <td>${truncateText(key, 120)}</td>
            <td><pre>${compact}</pre></td>
        `;
        fragment.appendChild(row);
    }

    body.appendChild(fragment);
    cacheOffset = end;

    setButtonState(
        "cacheMoreBtn",
        cacheOffset < cacheEntries.length,
        `Load More Cache (${cacheOffset}/${cacheEntries.length})`
    );
}

document.getElementById("recordsMoreBtn").addEventListener("click", () => {
    requestAnimationFrame(renderRecordsBatch);
});

document.getElementById("cacheMoreBtn").addEventListener("click", () => {
    requestAnimationFrame(renderCacheBatch);
});

fetch('data.json')
    .then(res => res.json())
    .then(data => {

        // CONFIG
        document.getElementById('configSection').innerHTML = `
            <strong>Version:</strong> ${data.version}<br>
            <strong>Year Range:</strong> ${data.config.start_year} - ${data.config.end_year}<br>
            <strong>Languages:</strong><br>
            ${data.config.languages.map(l => 
                `<span class="badge">${l}</span>`
            ).join('')}
        `;

        // COMPLETED
        document.getElementById('completedSection').innerHTML =
            data.completed_tasks.length
            ? data.completed_tasks.map(t => 
                `<div class="success">âœ” ${t}</div>`
              ).join('')
            : "No completed tasks";

        // FAILED
        const failedTable = document.getElementById('failedTable');
        Object.entries(data.failed_tasks || {}).forEach(([task, error]) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${task}</td>
                <td class="error">${error}</td>
            `;
            failedTable.appendChild(row);
        });

        // RECORDS
        recordsData = data.records || [];
        recordsOffset = 0;
        if (recordsData.length === 0) {
            document.getElementById('recordsTable').innerHTML =
                `<tr><td colspan="6" class="muted">No records</td></tr>`;
        } else {
            renderRecordsBatch();
        }

        // MOVIE DETAILS CACHE
        const cacheBody = document.getElementById('cacheBody');
        const cache = data.movie_details_cache || {};
        cacheEntries = Object.entries(cache);
        cacheOffset = 0;
        cacheBody.innerHTML = "";

        if (cacheEntries.length === 0) {
            cacheBody.innerHTML = `<tr><td colspan="2">No cached movie details</td></tr>`;
        } else {
            renderCacheBatch();
        }

    })
    .catch(err => console.error("Error loading JSON:", err));
</script>

</body>
</html>
